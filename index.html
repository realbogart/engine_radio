<html>
	<head>
		<title>No mercy...</title>
		<link rel="stylesheet" type="text/css" href="/style.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<script type="text/javascript" src="jquery.simple.websocket.js"></script>
		
		<script type="text/javascript">
			var commands = {};
			commands["reload"] = function( msgJson ){ $('link[href="/style.css"]').attr('href','/style.css'); };
			commands["setBackground"] = function( msgJson ){ $("body").css("background-image","url('"+msgJson.message+"')"); };
			commands["setActiveShow"] = function( msgJson ){ 
				for(i = 0; i < 10; i++)
				{
					$("#show"+i).removeClass("showActive");
					$("#show"+i).addClass("showInactive");
				}
				
				$("#show"+msgJson.message).addClass("showActive");
			};
			commands["setSchedule"] = function( msgJson ){ 
				var scheduleJson = msgJson.message;
				jQuery('#schedule').html('');

				var longestNameIndex = 0;
				var longestName = 0;
				jQuery.each(scheduleJson.shows, function(i, val) {
					var nameLength = val.name.length;
					if( val.name && nameLength > longestName )
					{
						longestName = val.name.length;
						longestNameIndex = i;
					}
				});

				var showIndex = 0;
				jQuery.each(scheduleJson.shows, function(i, val) {
					if( val.name )
					{
						var spacing = " ";
						var nameLength = val.name.length;
						for(i = 0; i < 3 + longestName - nameLength; i = i + 1)
						{
							spacing += "-"
						}
						spacing += " ";

						jQuery('#schedule').append('<p id="show'+showIndex+'" class="showInactive">'+val.name + spacing + val.time + '</p>');
						showIndex++;
					}
				});
			};
			commands["setMetaData"] = function( msgJson ){ 
				metaDataJson = JSON.parse( msgJson.message );
				
				jQuery('#nowPlaying').html('');
				
				if( metaDataJson.command == 'spotify' )
				{
					jQuery('#nowPlaying').append( '<iframe src="https://open.spotify.com/embed/track/'+metaDataJson.id+'" width="300" height="380" frameborder="0" allowtransparency="true"></iframe>' );
				}
			};
			var currentFirework = 0;
			commands["spawnFireworks"] = function( msgJson ){ 
				var fireworks = $('#fireworks'+currentFirework);
				currentFirework = (currentFirework + 1) % 20;
				fireworks.show();
				fireworks.css({top: msgJson.message.positionY + $(window).height() / 2, left: msgJson.message.positionX + $(window).width() / 2, position: "absolute" });
				setTimeout(function() { 
					fireworks.attr('src', '/fireworks.gif?hack='+currentFirework); 
				}, 0);
			};

			function runCommand( msgJson ) {
				if( msgJson.command in commands )
				{
					commands[msgJson.command](msgJson);
				}
				else
				{
					alert( "not found: " + msgJson.command );
				}
			}

			var webSocket = $.simpleWebSocket({ url: '<websocket_server>' });
			webSocket.connect();
			
			webSocket.isConnected(function(connected) {
				webSocket.send('connected');
			});
			
			webSocket.listen(function(msgString) {
				var msgJson = JSON.parse( msgString );
				runCommand( msgJson );
			});

			$(document).click(function(e){
				var center_x = $(window).width() / 2;
				var center_y = $(window).height() / 2;
				webSocket.send( { command : 'spawnFireworks', message : { positionX : e.pageX - center_x - 125, positionY : e.pageY - center_y - 125 } } );
			});
		</script>
	</head>
	<body>
		<img id="fireworks0" class="fireworks" src="/fireworks.gif">
		<img id="fireworks1" class="fireworks" src="/fireworks.gif">
		<img id="fireworks2" class="fireworks" src="/fireworks.gif">
		<img id="fireworks3" class="fireworks" src="/fireworks.gif">
		<img id="fireworks4" class="fireworks" src="/fireworks.gif">
		<img id="fireworks5" class="fireworks" src="/fireworks.gif">
		<img id="fireworks6" class="fireworks" src="/fireworks.gif">
		<img id="fireworks7" class="fireworks" src="/fireworks.gif">
		<img id="fireworks8" class="fireworks" src="/fireworks.gif">
		<img id="fireworks9" class="fireworks" src="/fireworks.gif">
		<img id="fireworks10" class="fireworks" src="/fireworks.gif">
		<img id="fireworks11" class="fireworks" src="/fireworks.gif">
		<img id="fireworks12" class="fireworks" src="/fireworks.gif">
		<img id="fireworks13" class="fireworks" src="/fireworks.gif">
		<img id="fireworks14" class="fireworks" src="/fireworks.gif">
		<img id="fireworks15" class="fireworks" src="/fireworks.gif">
		<img id="fireworks16" class="fireworks" src="/fireworks.gif">
		<img id="fireworks17" class="fireworks" src="/fireworks.gif">
		<img id="fireworks18" class="fireworks" src="/fireworks.gif">
		<img id="fireworks19" class="fireworks" src="/fireworks.gif">

		<div id="stream">
			<audio controls autoplay>
				<source src="<stream_ip>" id="audio" type="audio/mpeg">
			</audio>
		</div>
		
		<div id="schedule">
		</div>
		
		<div id="nowPlaying">
		</div>
	</body>
</html>
